---
layout: single
title: M1 Pro macbook 환경 세팅하기
categories: 
parlinks: []
comments : true
---
<div id="toc">
Contents
</div>
* TOC
{:toc}
----------


이번에 새 Macbook Pro 를 장만했습니다. 애플 실리콘으로 바뀌면서 환경설정이 정말 빡세기 때문에, 처참한 기록을 공유하고자 합니다. 

## Why macbook Pro?
저는 원래 2019년 5월쯤부터 macbook air 2018을 사용하고 있었기 때문에, 이제는 macOS의 개발환경이 더 익숙합니다. 에어의 성능에 한계를 느끼기도 했고, 언젠가는 꼭 맥북프로를 살 생각이었습니다. 2020년에 M1 칩이 공개된 이후 맥북에어를 살지 잠깐 고민을 했었지만, 크게 세가지 이유 때문에 포기했습니다.
- 2019년에 받은 맥북이 어쩌다보니 경품추첨으로 받게된것이긴 하지만, 받은지 2년도 안돼서 바꾸긴 좀 그렇기도 하고
- Pro가 아닌 Air 라인업인게 일단 좀 마음에 안 들고
- 결정적으로, Apple의 하드웨어 개발실력과는 무관하게 이렇게 큰 commitment가 처음으로 있을때는 (무슨 불안정함이 있을지 모르므로) 사는게 아니라고 생각해서입니다. 

M1 Pro가 장착된 이번 맥북프로는 이 모든 문제가 사실상 정리되었(다고 생각했)으므로, 이번에 구입하게 되었습니다. 상세 스펙은...
- 10 Core CPU, 16 Core GPU. 8코어와 10코어간에는 조금은 차이가 날것 같았습니다. 솔직히 말하면, 저는 영상작업이나 그래픽을 다루지 않으므로 14코어와 16코어 GPU간의 차이가 느껴질리 없지만 이왕 사는거..10만원만 더....
- 32 GB RAM.
- 512GB SSD. 저는 원래 딱히 저장용량이 부족하지 않습니다. 

## What's Different?
M1, 즉 Apple silicon 으로 변경하면서 어떤 점이 다른가? (성능이 우수한지에 대한 판단은 둘째치고) 

이 질문에 대답하려면 약간의 컴퓨터공학 지식이 필요합니다. 개발 툴을 세팅할 사람이라면 이것들을 알고 있을 테니, 대충 설명해보자면 (매우 엄밀한 설명은 아닙니다)

- 우리가 작성한 프로그램은 컴파일러가 '기계어' 로 번역하며 (실제로는 어셈블리로. 그러나 어셈블리-기계어는 일대일대응이므로...)
- CPU는 오직 이 '기계어' 만을 실행합니다.
- 즉, 컴파일러는 '이 CPU는 어떤 기계어 명령을 실행할 수 있는가' 를 인지하고 있어야 하며, 이를 최적으로 번역할 필요가 있습니다. 
- 따라서 'Apple의 기계어' 가 '다른 기계어' 와 다르다면, 이를 인지하고있는 컴파일러가 C++코드를 다시 번역해야 합니다. 
- 그러나 모든 프로그램을 다시 컴파일할 것을 요구하는 것은 좀 양심이 없으므로, 애플은 Rosetta라는 엄청난 프로그램을 사용합니다. 이 Rosetta는 'Intel 기계어로 번역된 프로그램' 을 'Apple 기계어로 번역' 합니다. 애플이 외계인을 고문하는지 이때 번역된 결과물의 성능은 놀랄만큼 훌륭하지만, 당연히 완벽하지는 않습니다. 
- 그 과정에서 약간의 문제들이 발생합니다.
  

이하, 글의 모든 내용은 제 개인적인 경험과 지식에 의한 것이며, 2021년 12월 이후 어떤 변경사항으로 인해 더이상 사실이 아니게 된 내용이 있을 수도 있습니다. 

## Step 0. Developer tools
여기는 애플이 모든걸 정식으로 제공하기 때문에 걱정할 필요가 없습니다. 
> `$ xcode-select --install` 
기다립니다. 

## Step 1. Homebrew 
터미널을 켜서 다음을 입력합니다. 
> `$ /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`
설치가 완료되면 설치를 확인합니다.
> `$ which brew`
결과물이 `/opt/homebrew/bin/brew` 이면 됩니다. 

## Step 2. Python
앞으로의 편의를 위해 brew를 믿습니다. 여기까진 (아마도) 문제가 없을 것입니다. 
> `$ brew install python@3.8`
현재 (2021.12) @3.8을 붙이지 않으면 3.9.9를 설치합니다. 이렇게 설치했을때 제 로컬환경에서는 tensorflow를 비롯한 여러 라이브러리들이 서로 싸움이 붙었었기 떄문에, 한버전을 내리는 것이 보다 정신 건강에 도움이 되는 길이었습니다.

**반드시** conda를 사용하기를 권합니다. 파이썬의 여러 패키지들 중, 어떤 패키지들은 M1을 지원하고 어떤 패키지들은 그렇지 않은데 이를 중구난방으로 설치하고 나면 놀라운 일들을 경험하게 됩니다. 현재는 miniforge를 이용하는 conda가 가장 안정적인 것 같습니다. [이 블로그 글](https://cpuu.postype.com/post/9077219?utm_source=postype&utm_medium=iframely) 을 참조하여 설치를 진행하였을 때 성공했습니다. 

마찬가지로, 이하의 글은 conda 환경을 **python 3.8로** 만들었다고 가정합니다. 

## Step 3. Deep Learning
Conda 환경 내에서는 `pip` 으로 설치하거나 `conda install` 로 설치하는 패키지들을 사용할 수 있으며, `pip3`은 기본적으로 로컬 머신의 기본 파이썬을 향해 설치하게 됩니다. 